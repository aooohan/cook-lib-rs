name: Build and Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., 0.1.0)'
        required: true
        type: string
      prerelease:
        description: 'Mark as pre-release'
        required: false
        type: boolean
        default: false

env:
  CARGO_TERM_COLOR: always
  SHERPA_BUILD_DEBUG: "1"

jobs:
  build-android:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        target:
          - { rust: aarch64-linux-android, ndk: arm64-v8a }
          - { rust: armv7-linux-androideabi, ndk: armeabi-v7a }
          - { rust: x86_64-linux-android, ndk: x86_64 }
          - { rust: i686-linux-android, ndk: x86 }
    steps:
      - uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target.rust }}

      - name: Setup Android NDK
        uses: nttld/setup-ndk@v1
        id: setup-ndk
        with:
          ndk-version: r26b

      - name: Install cargo-ndk and just
        run: cargo install cargo-ndk just

      - name: Build Android library
        env:
          ANDROID_NDK_HOME: ${{ steps.setup-ndk.outputs.ndk-path }}
        run: just build-android ${{ matrix.target.ndk }}

      - name: List built libraries
        run: ls -la android/src/main/jniLibs/${{ matrix.target.ndk }}/

      - name: Upload Android artifacts
        uses: actions/upload-artifact@v4
        with:
          name: android-${{ matrix.target.ndk }}
          path: android/src/main/jniLibs/${{ matrix.target.ndk }}/

  build-ios:
    runs-on: macos-latest
    strategy:
      matrix:
        target:
          - aarch64-apple-ios
          - aarch64-apple-ios-sim
          - x86_64-apple-ios
    steps:
      - uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Install just
        run: cargo install just

      - name: Build iOS library
        run: just build-ios-target ${{ matrix.target }}

      - name: Upload iOS artifact
        uses: actions/upload-artifact@v4
        with:
          name: ios-${{ matrix.target }}
          path: rust/target/${{ matrix.target }}/release/libcook_lib.a

  package-ios:
    needs: [build-ios]
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download iOS device artifact
        uses: actions/download-artifact@v4
        with:
          name: ios-aarch64-apple-ios
          path: artifacts/aarch64-apple-ios/

      - name: Download iOS simulator arm64 artifact
        uses: actions/download-artifact@v4
        with:
          name: ios-aarch64-apple-ios-sim
          path: artifacts/aarch64-apple-ios-sim/

      - name: Download iOS simulator x86_64 artifact
        uses: actions/download-artifact@v4
        with:
          name: ios-x86_64-apple-ios
          path: artifacts/x86_64-apple-ios/

      - name: Create XCFramework
        run: |
          mkdir -p ios/Frameworks

          # Remove existing xcframework if any
          rm -rf ios/Frameworks/cook_lib.xcframework

          # Create fat library for simulators
          mkdir -p artifacts/ios-simulator-universal
          lipo -create \
            artifacts/aarch64-apple-ios-sim/libcook_lib.a \
            artifacts/x86_64-apple-ios/libcook_lib.a \
            -output artifacts/ios-simulator-universal/libcook_lib.a

          # Create XCFramework
          xcodebuild -create-xcframework \
            -library artifacts/aarch64-apple-ios/libcook_lib.a \
            -library artifacts/ios-simulator-universal/libcook_lib.a \
            -output ios/Frameworks/cook_lib.xcframework

      - name: Upload iOS XCFramework
        uses: actions/upload-artifact@v4
        with:
          name: ios-libs
          path: ios/Frameworks/

  generate-bindings:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install flutter_rust_bridge_codegen
        run: cargo install flutter_rust_bridge_codegen cargo-expand

      - name: Generate Dart bindings
        run: |
          flutter pub get
          flutter_rust_bridge_codegen generate

      - name: Upload Dart bindings
        uses: actions/upload-artifact@v4
        with:
          name: dart-bindings
          path: lib/src/rust/

  commit-and-release:
    needs: [build-android, package-ios, generate-bindings]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Download Android arm64-v8a
        uses: actions/download-artifact@v4
        with:
          name: android-arm64-v8a
          path: android/src/main/jniLibs/arm64-v8a/

      - name: Download Android armeabi-v7a
        uses: actions/download-artifact@v4
        with:
          name: android-armeabi-v7a
          path: android/src/main/jniLibs/armeabi-v7a/

      - name: Download Android x86_64
        uses: actions/download-artifact@v4
        with:
          name: android-x86_64
          path: android/src/main/jniLibs/x86_64/

      - name: Download Android x86
        uses: actions/download-artifact@v4
        with:
          name: android-x86
          path: android/src/main/jniLibs/x86/

      - name: Download iOS artifacts
        uses: actions/download-artifact@v4
        with:
          name: ios-libs
          path: ios/Frameworks/

      - name: Download Dart bindings
        uses: actions/download-artifact@v4
        with:
          name: dart-bindings
          path: lib/src/rust/

      - name: Update version in pubspec.yaml
        run: |
          sed -i "s/^version: .*/version: ${{ inputs.version }}/" pubspec.yaml

      - name: Commit and push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -f android/src/main/jniLibs ios/Frameworks lib/src/rust pubspec.yaml
          git diff --cached --stat
          git commit -m "Release v${{ inputs.version }}: update native libraries and bindings"
          git push

      - name: Create tag
        run: |
          git tag v${{ inputs.version }}
          git push origin v${{ inputs.version }}

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ inputs.version }}
          name: v${{ inputs.version }}
          prerelease: ${{ inputs.prerelease }}
          generate_release_notes: true
          body: |
            ## Cook Lib v${{ inputs.version }}

            ### Installation

            ```yaml
            dependencies:
              cook_lib:
                git:
                  url: https://github.com/${{ github.repository }}.git
                  ref: v${{ inputs.version }}
            ```

            ### Supported Platforms

            **Android:** arm64-v8a, armeabi-v7a, x86_64, x86
            **iOS:** arm64 device, arm64 + x86_64 simulator
